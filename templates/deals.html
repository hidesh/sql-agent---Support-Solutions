<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deals - Support Solutions CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="main-container">
        <div class="container-fluid">
            <!-- Hero Section -->
            <div class="hero-section">
                <h1 class="hero-title">
                    <i class="fas fa-handshake me-3"></i>Deal Pipeline
                </h1>
                <p class="hero-subtitle">
                    Administrer sales muligheder og deal flow
                </p>
                
                <!-- CRM Navigation -->
                <div class="crm-nav">
                    <a href="/" class="nav-btn">
                        <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                    </a>
                    <a href="/customers" class="nav-btn">
                        <i class="fas fa-users me-1"></i> Kunder
                    </a>
                    <a href="/deals" class="nav-btn active">
                        <i class="fas fa-handshake me-1"></i> Deals
                    </a>
                    <a href="/projects" class="nav-btn">
                        <i class="fas fa-project-diagram me-1"></i> Projekter
                    </a>
                    <a href="/consultants" class="nav-btn">
                        <i class="fas fa-user-tie me-1"></i> Konsulenter
                    </a>
                    <a href="/activities" class="nav-btn">
                        <i class="fas fa-calendar me-1"></i> Aktiviteter
                    </a>
                </div>
            </div>

            <!-- Deal Stats -->
            <div class="quick-insights">
                <div class="insight-card">
                    <div class="insight-number">{{ stats.total_deals or 0 }}</div>
                    <div class="insight-label">Aktive Deals</div>
                    <div class="insight-trend"><i class="fas fa-handshake"></i> I pipeline</div>
                </div>
                <div class="insight-card">
                    <div class="insight-number">{{ (stats.total_value/1000000)|round(1) if stats.total_value else 0 }}M</div>
                    <div class="insight-label">Pipeline Værdi</div>
                    <div class="insight-trend"><i class="fas fa-money-bill-wave"></i> DKK</div>
                </div>
                <div class="insight-card">
                    <div class="insight-number">{{ stats.avg_probability|round(0) if stats.avg_probability else 0 }}%</div>
                    <div class="insight-label">Gennemsnit Success Rate</div>
                    <div class="insight-trend"><i class="fas fa-chart-line"></i> Sandsynlighed</div>
                </div>
                <div class="insight-card">
                    <div class="insight-number">{{ stats.closing_this_month or 0 }}</div>
                    <div class="insight-label">Lukker denne måned</div>
                    <div class="insight-trend"><i class="fas fa-calendar-check"></i> Hot deals</div>
                </div>
            </div>

            <!-- Main Card -->
            <div class="glass-card">
                <div class="search-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3><i class="fas fa-handshake me-2"></i>Sales Pipeline</h3>
                        <div class="btn-group">
                            <button class="btn btn-outline-primary btn-sm active" onclick="filterDeals('all')">
                                <i class="fas fa-globe"></i> Alle
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="filterDeals('hot')">
                                <i class="fas fa-fire"></i> Hot (>70%)
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="filterDeals('negotiation')">
                                <i class="fas fa-comments"></i> Negotiation
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="filterDeals('closing')">
                                <i class="fas fa-calendar"></i> Lukker snart
                            </button>
                        </div>
                    </div>

                    <!-- Deal Filters -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="dealSearch" placeholder="Søg efter deal titel eller kunde...">
                        </div>
                        <div class="col-md-4">
                            <select class="form-control" id="stageFilter">
                                <option value="">Alle stadier</option>
                                <option value="Prospecting">Prospecting</option>
                                <option value="Qualified">Qualified</option>
                                <option value="Proposal">Proposal</option>
                                <option value="Negotiation">Negotiation</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-control" id="consultantFilter">
                                <option value="">Alle konsulenter</option>
                                {% for consultant in consultants %}
                                <option value="{{ consultant.id }}">{{ consultant.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Deal List -->
                <div class="result-section">
                    <div class="table-responsive">
                        <table class="table" id="dealTable">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-file-contract me-1"></i>Deal</th>
                                    <th><i class="fas fa-building me-1"></i>Kunde</th>
                                    <th><i class="fas fa-money-bill me-1"></i>Værdi</th>
                                    <th><i class="fas fa-percentage me-1"></i>Sandsynlighed</th>
                                    <th><i class="fas fa-tasks me-1"></i>Stadium</th>
                                    <th><i class="fas fa-calendar me-1"></i>Forventet lukkedato</th>
                                    <th><i class="fas fa-user-tie me-1"></i>Konsulent</th>
                                    <th><i class="fas fa-cogs me-1"></i>Handlinger</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for deal in deals %}
                                <tr data-stage="{{ deal.stage }}" data-probability="{{ deal.probability }}" data-consultant="{{ deal.assigned_consultant_id }}">
                                    <td>
                                        <strong>{{ deal.title }}</strong>
                                        {% if deal.description %}
                                        <br><small class="text-muted">{{ deal.description[:50] }}...</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ deal.customer_name or 'Ikke tildelt' }}</td>
                                    <td>
                                        <strong class="text-primary">
                                            {% if deal.value > 1000000 %}
                                                {{ (deal.value/1000000)|round(1) }}M DKK
                                            {% elif deal.value > 1000 %}
                                                {{ (deal.value/1000)|round(0) }}K DKK
                                            {% else %}
                                                {{ deal.value|round(0) }} DKK
                                            {% endif %}
                                        </strong>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar 
                                                {% if deal.probability >= 80 %}bg-success{% endif %}
                                                {% if deal.probability >= 60 and deal.probability < 80 %}bg-info{% endif %}
                                                {% if deal.probability >= 40 and deal.probability < 60 %}bg-warning{% endif %}
                                                {% if deal.probability < 40 %}bg-danger{% endif %}"
                                                data-width="{{ deal.probability }}">
                                                {{ deal.probability }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge 
                                            {% if deal.stage == 'Negotiation' %}badge-progress{% endif %}
                                            {% if deal.stage == 'Proposal' %}badge-progress{% endif %}
                                            {% if deal.stage == 'Qualified' %}badge-active{% endif %}
                                            {% if deal.stage == 'Prospecting' %}badge-planning{% endif %}
                                        ">{{ deal.stage }}</span>
                                    </td>
                                    <td>{{ deal.expected_close_date or 'TBD' }}</td>
                                    <td>{{ deal.consultant_name or 'Ikke tildelt' }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="/deal/{{ deal.id }}" class="btn btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                                                                        <button class="btn btn-outline-success" data-deal-id="{{ deal.id }}" onclick="createProject(this.dataset.dealId)">
                                                <i class="fas fa-plus"></i> Projekt
                                            </button>
                                            <button class="btn btn-outline-info" data-deal-id="{{ deal.id }}" onclick="addActivity(this.dataset.dealId)">
                                                <i class="fas fa-calendar-plus"></i> Aktivitet
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function filterDeals(type) {
            const rows = document.querySelectorAll('#dealTable tbody tr');
            
            // Update button states
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            rows.forEach(row => {
                const probability = parseInt(row.dataset.probability);
                const stage = row.dataset.stage;
                
                switch(type) {
                    case 'all':
                        row.style.display = '';
                        break;
                    case 'hot':
                        row.style.display = probability > 70 ? '' : 'none';
                        break;
                    case 'negotiation':
                        row.style.display = stage === 'Negotiation' ? '' : 'none';
                        break;
                    case 'closing':
                        // Show deals closing within next month (simplified)
                        row.style.display = probability > 60 ? '' : 'none';
                        break;
                }
            });
        }
        
        // Search functionality
        document.getElementById('dealSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#dealTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
        
        // Stage filter
        document.getElementById('stageFilter').addEventListener('change', function() {
            const selectedStage = this.value;
            const rows = document.querySelectorAll('#dealTable tbody tr');
            
            rows.forEach(row => {
                if (!selectedStage || row.dataset.stage === selectedStage) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Consultant filter
        document.getElementById('consultantFilter').addEventListener('change', function() {
            const selectedConsultant = this.value;
            const rows = document.querySelectorAll('#dealTable tbody tr');
            
            rows.forEach(row => {
                if (!selectedConsultant || row.dataset.consultant === selectedConsultant) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Set progress bar widths from data attributes
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[data-width]').forEach(function(element) {
                const width = element.getAttribute('data-width');
                element.style.width = width + '%';
            });
        });
        
        function createProject(dealId) {
            alert('Opretter projekt for deal ID: ' + dealId);
            // Would redirect to project creation form
        }
        
        function addActivity(dealId) {
            alert('Tilføjer aktivitet for deal ID: ' + dealId);
            // Would open activity creation modal
        }
    </script>
</body>
</html>