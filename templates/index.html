<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Solutions CRM - Intelligent Customer Relationship Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Support Solutions Brand Colors - Based on their actual palette */
            --primary: #333333;           /* Main dark gray from their design */
            --primary-dark: #000000;      /* True black */
            --secondary: #696969;         /* Medium gray */
            --success: #1634F;           /* Blue accent from palette */
            --danger: #FF9C00;           /* Orange accent - using as alert color */
            --warning: #444655;          /* Purple-gray from palette */
            --info: #0E1F3F;            /* Dark blue */
            --light-bg: #F6F6F6;        /* Very light gray background */
            --border: #E6E6E6;          /* Light gray border */
            --support-blue: #1634F;     /* Brand blue */
            --support-light: #A8AABC;   /* Light purple-gray */
        }
        
        body {
            background: linear-gradient(135deg, #333333 0%, #696969 50%, #A8AABC 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
        }
        
        .main-container {
            min-height: 100vh;
            padding: 1rem 0;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
        }
        
        .hero-section {
            text-align: center;
            padding: 2rem 2rem 1rem 2rem;
            color: white;
        }
        
        .hero-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #fff, #F6F6F6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .hero-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }
        
        .crm-nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            margin: 1rem 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary);
            transform: translateY(-1px);
        }
        
        .search-section {
            padding: 1.5rem 2rem;
        }
        
        .search-input {
            border: none;
            border-radius: 15px;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
            border-color: var(--primary);
        }
        
        .search-btn {
            border-radius: 15px;
            padding: 1rem 2rem;
            font-weight: 600;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            transition: all 0.3s ease;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(51, 51, 51, 0.3);
        }
        
        .quick-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            padding: 1.5rem 2rem;
            margin-bottom: 1rem;
        }
        
        .insight-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            border: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .insight-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(51, 51, 51, 0.3);
        }
        
        .insight-number {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .insight-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .insight-trend {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            opacity: 0.8;
        }
        
        .example-queries {
            background: var(--light-bg);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .query-category {
            margin-bottom: 1rem;
        }
        
        .category-title {
            font-weight: 600;
            color: var(--support-blue);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .example-query {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.6rem 1rem;
            margin: 0.3rem 0.3rem 0.3rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            font-size: 0.9rem;
        }
        
        .example-query:hover {
            background: var(--support-blue);
            color: white;
            transform: translateY(-1px);
        }
        
        .result-section {
            padding: 1.5rem 2rem;
            margin-top: 1rem;
        }
        
        .result-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .sql-code {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            position: relative;
        }
        
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            max-height: 500px;
            overflow-y: auto;
        }
        
        .table {
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        
        .table thead th {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.75rem;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            position: sticky;
            top: 0;
        }
        
        .table tbody td {
            padding: 0.75rem;
            border-color: var(--border);
            vertical-align: middle;
        }
        
        .table tbody tr:nth-child(even) {
            background: var(--light-bg);
        }
        
        .table tbody tr:hover {
            background: var(--support-light);
        }
        
        .alert-custom {
            border: none;
            border-radius: 15px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-success { background: var(--success); }
        .status-error { background: var(--danger); }
        .status-warning { background: var(--warning); }
        
        .status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-active { background: #e8f5e8; color: #1b5e20; }
        .badge-progress { background: #fff3e0; color: #f57c00; }
        .badge-won { background: #e3f2fd; color: var(--support-blue); }
        .badge-planning { background: var(--light-bg); color: var(--primary); }
        
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.2rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--support-blue);
        }
        
        .stat-label {
            color: var(--secondary);
            font-size: 0.8rem;
            margin-top: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .data-visualization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        @media (max-width: 768px) {
            .data-visualization {
                grid-template-columns: 1fr;
            }
            .quick-insights {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            .hero-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="container-fluid">
            <!-- Hero Section -->
            <div class="hero-section">
                <div class="d-flex align-items-center justify-content-center mb-3">
                    <img src="https://support-solutions.dk/wp-content/uploads/Logo-hvid-web.png" 
                         alt="Support Solutions Logo" 
                         style="height: 60px; width: auto; margin-right: 1rem;">
                    <h1 class="hero-title mb-0">
                        Support Solutions CRM
                    </h1>
                </div>
                <p class="hero-subtitle">
                    Intelligent Customer Relationship Management System
                </p>
                
                <!-- CRM Navigation -->
                <div class="crm-nav">
                    <a href="/" class="nav-btn active">
                        <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                    </a>
                    <a href="/customers" class="nav-btn">
                        <i class="fas fa-users me-1"></i> Kunder
                    </a>
                    <a href="/deals" class="nav-btn">
                        <i class="fas fa-handshake me-1"></i> Deals
                    </a>
                    <a href="/projects" class="nav-btn">
                        <i class="fas fa-project-diagram me-1"></i> Projekter
                    </a>
                    <a href="/consultants" class="nav-btn">
                        <i class="fas fa-user-tie me-1"></i> Konsulenter
                    </a>
                    <a href="/activities" class="nav-btn">
                        <i class="fas fa-calendar me-1"></i> Aktiviteter
                    </a>
                </div>
            </div>

            <!-- Quick Insights Dashboard -->
            <div class="quick-insights" id="quickInsights">
                <div class="insight-card" onclick="setQuery('SELECT COUNT(*) as antal_kunder FROM customers WHERE status = \'Active\'')">
                    <div class="insight-number">8</div>
                    <div class="insight-label">Aktive Kunder</div>
                    <div class="insight-trend"><i class="fas fa-arrow-up"></i> +2 denne måned</div>
                </div>
                <div class="insight-card" onclick="setQuery('SELECT COUNT(*) as aktive_deals FROM deals WHERE stage NOT IN (\'Closed Won\', \'Closed Lost\')')">
                    <div class="insight-number">8</div>
                    <div class="insight-label">Aktive Deals</div>
                    <div class="insight-trend"><i class="fas fa-chart-line"></i> 75% success rate</div>
                </div>
                <div class="insight-card" onclick="setQuery('SELECT COUNT(*) as aktive_projekter FROM projects WHERE status = \'In Progress\'')">
                    <div class="insight-number">2</div>
                    <div class="insight-label">Igangværende Projekter</div>
                    <div class="insight-trend"><i class="fas fa-clock"></i> I rute</div>
                </div>
                <div class="insight-card" onclick="setQuery('SELECT ROUND(SUM(value)/1000000, 1) as total_value FROM deals')">
                    <div class="insight-number">3.9M</div>
                    <div class="insight-label">Total Deal Værdi</div>
                    <div class="insight-trend"><i class="fas fa-money-bill-wave"></i> DKK</div>
                </div>
            </div>

            <!-- Main Card -->
            <div class="glass-card">
                <!-- Search Section -->
                <div class="search-section">
                    <form method="post" id="queryForm">
                        <div class="row">
                            <div class="col-md-9 col-sm-8">
                                <input type="text" class="form-control search-input" name="question" 
                                       placeholder="F.eks. 'Vis kunder med høj værdi' eller 'Hvilke deals lukker denne måned?'" 
                                       required value="{{ question or '' }}">
                            </div>
                            <div class="col-md-3 col-sm-4">
                                <button class="btn btn-primary search-btn w-100" type="submit">
                                    <i class="fas fa-search me-2"></i>Analyser
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Collapsible CRM Example Queries -->
                    <button class="collapse-btn" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#exampleQueries" aria-expanded="false" 
                            aria-controls="exampleQueries">
                        <i class="fas fa-lightbulb"></i>
                        Vis CRM Query Eksempler
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    
                    <div class="collapse" id="exampleQueries">
                        <div class="example-queries">
                            <div class="query-category">
                                <div class="category-title"><i class="fas fa-users me-1"></i> Kunder</div>
                                <div class="example-query" onclick="fillQuery('Vis alle kunder sorteret efter værdi')">Top kunder efter værdi</div>
                                <div class="example-query" onclick="fillQuery('Hvilke kunder har vi i finanssektoren?')">Finanssektorens kunder</div>
                                <div class="example-query" onclick="fillQuery('Kunder fra Jylland')">Jyllandske kunder</div>
                                <div class="example-query" onclick="fillQuery('Store kunder i København')">Københavnske kunder</div>
                                <div class="example-query" onclick="fillQuery('Nye kunder i 2024')">Nye kunder 2024</div>
                            </div>
                            
                            <div class="query-category">
                                <div class="category-title"><i class="fas fa-handshake me-1"></i> Sales & Deals</div>
                                <div class="example-query" onclick="fillQuery('Vis deals der lukker denne måned')">Lukkende deals</div>
                                <div class="example-query" onclick="fillQuery('Hvilke deals har høj sandsynlighed?')">Hot prospects</div>
                                <div class="example-query" onclick="fillQuery('Total dealværdi pr konsulent')">Sales performance</div>
                            </div>
                            
                            <div class="query-category">
                                <div class="category-title"><i class="fas fa-project-diagram me-1"></i> Projekter</div>
                                <div class="example-query" onclick="fillQuery('Aktive projekter med status')">Igangværende projekter</div>
                                <div class="example-query" onclick="fillQuery('Projekter over budget')">Budget overskridelser</div>
                                <div class="example-query" onclick="fillQuery('Gennemsnitlig projektvarighed')">Projekt performance</div>
                            </div>
                            
                            <div class="query-category">
                                <div class="category-title"><i class="fas fa-chart-bar me-1"></i> Analytik</div>
                                <div class="example-query" onclick="fillQuery('Monthly revenue trend')">Månedlig omsætning</div>
                                <div class="example-query" onclick="fillQuery('Konsulent utilization rate')">Konsulent udnyttelse</div>
                                <div class="example-query" onclick="fillQuery('Geografisk fordeling af kunder')">Kunde geografi</div>
                                <div class="example-query" onclick="fillQuery('IT virksomheder i Midtjylland')">IT i Midtjylland</div>
                                <div class="example-query" onclick="fillQuery('Customer satisfaction scores')">Kundetilfredshed</div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if question %}
                <div class="result-section">
                    <!-- Collapsible Query Display -->
                    <button class="collapse-btn" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#queryDisplay" aria-expanded="false" 
                            aria-controls="queryDisplay">
                        <i class="fas fa-question-circle"></i>
                        CRM Forespørgsel: "{{ question }}"
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    
                    <div class="collapse" id="queryDisplay">
                        <div class="result-card">
                            <h5 class="mb-3">
                                <i class="fas fa-question-circle me-2 text-primary"></i>CRM Forespørgsel:
                            </h5>
                            <div class="alert alert-info alert-custom">
                                <strong>"{{ question }}"</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible SQL Display -->
                    <button class="collapse-btn" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#sqlDisplay" aria-expanded="false" 
                            aria-controls="sqlDisplay">
                        <i class="fas fa-code"></i>
                        Vis Genereret SQL Query
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    
                    <div class="collapse" id="sqlDisplay">
                        <div class="result-card">
                            <h5 class="mb-3">
                                <i class="fas fa-code me-2 text-primary"></i>Genereret SQL Query:
                            </h5>
                            <div class="sql-code">
                                <button class="copy-btn" onclick="copySQL()">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <span id="sqlContent">{{ sql }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Results -->
                    {% if error %}
                        <div class="result-card">
                            <div class="alert alert-danger alert-custom">
                                <span class="status-indicator status-error"></span>
                                <strong>Database Fejl:</strong> {{ error }}
                                <div class="mt-2 small">
                                    <i class="fas fa-lightbulb"></i> Tip: Prøv at omformulere dit spørgsmål eller vælg et eksempel ovenfor.
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="result-card">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2 text-success"></i>CRM Data:
                                </h5>
                                <span class="badge bg-success">
                                    <span class="status-indicator status-success"></span>
                                    {{ answer|length }} {% if answer|length == 1 %}post{% else %}poster{% endif %}
                                </span>
                            </div>
                            
                            {% if answer|length > 0 %}
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-number">{{ answer|length }}</div>
                                        <div class="stat-label">Datapunkter</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">{{ answer[0].keys()|length }}</div>
                                        <div class="stat-label">Datafelter</div>
                                    </div>
                                    {% if answer[0].get('value') or answer[0].get('total_value') or answer[0].get('budget') or answer[0].get('amount') %}
                                    <div class="stat-card">
                                        <div class="stat-number">
                                            {% set value_field = 'value' if answer[0].get('value') else ('total_value' if answer[0].get('total_value') else ('budget' if answer[0].get('budget') else 'amount')) %}
                                            {% set total = answer|sum(attribute=value_field) %}
                                            {% if total > 1000000 %}
                                                {{ (total/1000000)|round(1) }}M
                                            {% elif total > 1000 %}
                                                {{ (total/1000)|round(1) }}K
                                            {% else %}
                                                {{ total|round(0) }}
                                            {% endif %}
                                        </div>
                                        <div class="stat-label">Total Værdi (DKK)</div>
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                {% for col in answer[0].keys() %}
                                                    <th>
                                                        <i class="fas fa-columns me-1"></i>{{ col|title|replace('_', ' ') }}
                                                    </th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for row in answer %}
                                                <tr>
                                                    {% for col, val in row.items() %}
                                                        <td>
                                                            {% if col == 'status' %}
                                                                <span class="status-badge 
                                                                    {% if val == 'Active' or val == 'In Progress' %}badge-active{% endif %}
                                                                    {% if val == 'Planning' %}badge-planning{% endif %}
                                                                    {% if val == 'Closed Won' or val == 'Completed' %}badge-won{% endif %}
                                                                    {% if val == 'Negotiation' or val == 'Proposal' %}badge-progress{% endif %}
                                                                ">{{ val or '-' }}</span>
                                                            {% elif col == 'stage' %}
                                                                <span class="status-badge 
                                                                    {% if val == 'Closed Won' %}badge-won{% endif %}
                                                                    {% if val in ['Negotiation', 'Proposal'] %}badge-progress{% endif %}
                                                                    {% if val in ['Prospecting', 'Qualified'] %}badge-planning{% endif %}
                                                                ">{{ val or '-' }}</span>
                                                            {% elif col in ['value', 'total_value', 'budget', 'actual_cost'] and val %}
                                                                {% if val > 1000000 %}
                                                                    {{ (val/1000000)|round(1) }}M DKK
                                                                {% elif val > 1000 %}
                                                                    {{ (val/1000)|round(0) }}K DKK
                                                                {% else %}
                                                                    {{ val|round(0) }} DKK
                                                                {% endif %}
                                                            {% elif col in ['email'] and val %}
                                                                <a href="mailto:{{ val }}" class="text-primary">{{ val }}</a>
                                                            {% elif col in ['phone'] and val %}
                                                                <a href="tel:{{ val }}" class="text-primary">{{ val }}</a>
                                                            {% else %}
                                                                {{ val if val is not none else '-' }}
                                                            {% endif %}
                                                        </td>
                                                    {% endfor %}
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                {% if ai_explanation %}
                                    <div class="alert alert-info alert-custom">
                                        <div class="d-flex align-items-start">
                                            <span class="me-3" style="font-size: 1.5rem;">🤖</span>
                                            <div>
                                                <strong>AI Assistent:</strong>
                                                <div class="mt-2">{{ ai_explanation }}</div>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning alert-custom">
                                        <span class="status-indicator status-warning"></span>
                                        Ingen CRM data fundet for denne forespørgsel.
                                        <div class="mt-2 small">
                                            Prøv at udvide søgekriterierne eller vælg et af eksemplerne ovenfor.
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Loading Animation med Robot
        function showLoading() {
            // Først skjul search section
            const searchSection = document.querySelector('.search-section');
            if (searchSection) {
                searchSection.style.opacity = '0.5';
                searchSection.style.pointerEvents = 'none';
            }

            // Find eller opret result section
            let resultSection = document.querySelector('.result-section');
            if (!resultSection) {
                const mainCard = document.querySelector('.glass-card');
                const loadingHTML = `
                    <div class="result-section">
                        <div class="loading-container">
                            <div class="loading-spinner">⚙️</div>
                            <div class="loading-text">
                                <i class="fas fa-brain me-2"></i>AI analyserer dit CRM spørgsmål...
                            </div>
                        </div>
                    </div>
                `;
                mainCard.insertAdjacentHTML('beforeend', loadingHTML);
            } else {
                // Erstat indhold med loading
                resultSection.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner">⚙️</div>
                        <div class="loading-text">
                            <i class="fas fa-brain me-2"></i>AI analyserer dit CRM spørgsmål...
                        </div>
                    </div>
                `;
            }

            // Scroll til loading section
            const loadingContainer = document.querySelector('.loading-container');
            if (loadingContainer) {
                setTimeout(() => {
                    loadingContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        // Form submit handler med bedre loading
        document.getElementById('queryForm').addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Ændr knap til loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyserer...';
            submitBtn.disabled = true;
            
            // Vis loading animation
            showLoading();
            
            // Let form submit efter kort delay for at vise animation
            setTimeout(() => {
                // Reset button efter submit (hvis der er fejl)
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    const searchSection = document.querySelector('.search-section');
                    if (searchSection) {
                        searchSection.style.opacity = '1';
                        searchSection.style.pointerEvents = 'auto';
                    }
                }, 3000);
            }, 200);
        });

        function fillQuery(query) {
            document.querySelector('input[name="question"]').value = query;
        }
        
        function setQuery(query) {
            document.querySelector('input[name="question"]').value = query;
            
            // Trigger loading animation
            const event = new Event('submit');
            const form = document.getElementById('queryForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // Ændr knap til loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyserer...';
            submitBtn.disabled = true;
            
            // Vis loading
            showLoading();
            
            // Submit efter delay
            setTimeout(() => {
                form.submit();
            }, 500);
        }
        
        function setNavActive(element) {
            // Remove active from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            // Add active to clicked button
            element.classList.add('active');
        }
        
        function showDashboard() {
            setNavActive(event.target.closest('.nav-btn'));
            // Clear any previous query results
            window.location.href = '/';
        }
        
        function setNavActive(element) {
            // Remove active from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            // Add active to clicked button
            if (element) element.classList.add('active');
        }
        
        function copySQL() {
            const sqlContent = document.getElementById('sqlContent').textContent;
            navigator.clipboard.writeText(sqlContent).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 2000);
            });
        }
        
        // Add loading state to form submission
        document.getElementById('queryForm').addEventListener('submit', function(e) {
            const btn = this.querySelector('button[type="submit"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Analyserer CRM...';
            btn.disabled = true;
            
            // Re-enable after timeout
            setTimeout(() => {
                if (btn.disabled) {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }
            }, 15000);
        });
        
        // Auto-refresh insights (could be connected to real data)
        function updateInsights() {
            // This would fetch real-time CRM stats
            console.log('Updating CRM insights...');
        }
        
        // Update insights every 30 seconds
        setInterval(updateInsights, 30000);
        
        // Quick action buttons for insights
        document.addEventListener('DOMContentLoaded', function() {
            // Make insight cards clickable with better queries
            const insightCards = document.querySelectorAll('.insight-card');
            if (insightCards.length >= 4) {
                insightCards[0].onclick = () => setQuery('SELECT company_name, total_value, status FROM customers WHERE status = "Active" ORDER BY total_value DESC');
                insightCards[1].onclick = () => setQuery('SELECT title, value, stage, probability FROM deals WHERE stage NOT IN ("Closed Won", "Closed Lost") ORDER BY value DESC');
                insightCards[2].onclick = () => setQuery('SELECT p.name, c.company_name, p.status, p.budget, p.actual_cost FROM projects p LEFT JOIN customers c ON p.customer_id = c.id WHERE p.status = "In Progress"');
                insightCards[3].onclick = () => setQuery('SELECT SUM(value) as total_pipeline_value, COUNT(*) as active_deals FROM deals WHERE stage NOT IN ("Closed Won", "Closed Lost")');
            }
        });
    </script>
</body>
</html>